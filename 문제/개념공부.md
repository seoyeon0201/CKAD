## Rolling Update

- Recreate 전략과 달리 구버전을 하나씩 내리고 신버전을 하나씩 순차적인 올리는 방식 사용

- `k create -f [YAML FILE] --record`

  - 리소스 생성하면서 동시에 기록
  - 생성시 `--record`하지 않으면 `k rollout history deployment/[DEPLOYMENT NAME]`에 보이지 않음

- `k rollout statue deployment/[DEPLOYMENT NAME]`
  - rollout되는 상태 지켜봄
- `k rollout history deployment/[DEPLOYMENT NAME]`

  - history 조회

- Rolling update 방식

  - 1. YAML 파일 수정
    - YAML 파일에서 image 수정 후 `k apply -f [YAML FILE]`
  - 2. 명령어로 업데이트
    - `k set image deployment/[DEPLOYMENT NAME] [CONTAINER NAME]=[변경할 image]`

- `k rollout undo deployment/[DEPLOYMENT NAME]`
  - 이전 버전으로 rollback

## Blue/Green

- version:v1의 label을 가진 deployment와 version:v1을 selector하는 service 존재
- version:v2의 label을 가진 deployment 생성
- service의 selector을 version: v1에서 version: v2로 변경

## Canary

- 새 버전의 deployment를 배포해 소량의 트래픽만 경로 지정
  - 대부분의 트래픽은 구버전으로 가지만 소량의 일부 트래픽은 신버전으로 감
- 정상적으로 동작하면 구버전을 신버전으로 변경
  - rolling update 방식으로 변경
- 처음에 소량의 트래픽 경로로 지정한 canary 제거

#### 해결해야하는 문제

1. 구버전과 신버전의 deployment로 동시에 트래픽 전달해줘야함

- 구버전과 신버전이 `label을 공통`으로 가지도록 설정하고, `service는 공통으로 갖는 label을 selector 매핑`

  - 이때 트래픽 비율을 결정하고 싶은 경우, service의 selector와 deployment의 pod의 label이 맞아야 함 !

2. 신버전에는 작은 퍼센트의 트래픽이 가야함

- traffic은 pod의 수에 따라 결정되므로 신버전의 `pod 수를 줄임`

## Secret

- Secret을 인코드하여 넣기 위해서 `echo -n '[SECRET의 VALUE값]' | base64`

- 디코드하여 값을 찾기 위해 `echo -n '[SECRET의 인코딩된 VALUE값]'|base64 --decode`

- secret은 아래와 같이 data의 value가 인코딩되어나타나 값을 알기 위해서는 디코딩해야함
`secret.yaml`
```
apiVersion: v1
kind: Secret
metadata:
    name: app-secret
data:
    DB_Host: bXlzcWw=
    DB_User: cm9vdA==
    DB_Password: cGFzd3Jk
```

## Security Context

- Kubernetes는 container 실행시 기본으로 root 권한으로 실행되는데, root 권한에서의 container 실행을 방지하기 위해 실행시킬 PID 지정
- pod 또는 container에 대한 권한 및 액세스 제어 설정 정의
- spec.securityContext인 경우 kind에 해당하는 리소스 전체에 권한 및 액세스 제어가 가능하고, spec.containers.securityContext의 경우 해당 container내에서 권한 및 액세스 제어를 할 수 있음

- Option
    - `runAsUser`: pod 또는 container를 실행시킬 PID 지정
    - `runAsGroup`: pod 또는 container를 실행시킬 GID 지정
    - `fsGroup`: volumeMount시 활용할 PID 지정
    - `runAsNonRoot`: container를 root가 아닌 사용자로 실행할지 지정

